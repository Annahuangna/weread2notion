name: read time sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *'
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  sync:
    name: Sync
    runs-on: ubuntu-latest
    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_PAGE: ${{ secrets.NOTION_PAGE }}
      WEREAD_COOKIE: ${{ secrets.WEREAD_COOKIE }}
      CC_URL: ${{ secrets.CC_URL }}
      CC_ID: ${{ secrets.CC_ID }}
      CC_PASSWORD: ${{ secrets.CC_PASSWORD }}
      BOOK_DATABASE_NAME: ${{ vars.BOOK_DATABASE_NAME }}
      AUTHOR_DATABASE_NAME: ${{ vars.AUTHOR_DATABASE_NAME }}
      CATEGORY_DATABASE_NAME: ${{ vars.CATEGORY_DATABASE_NAME }}
      BOOKMARK_DATABASE_NAME: ${{ vars.BOOKMARK_DATABASE_NAME }}
      REVIEW_DATABASE_NAME: ${{ vars.REVIEW_DATABASE_NAME }}
      CHAPTER_DATABASE_NAME: ${{ vars.CHAPTER_DATABASE_NAME }}
      YEAR_DATABASE_NAME: ${{ vars.YEAR_DATABASE_NAME }}
      WEEK_DATABASE_NAME: ${{ vars.WEEK_DATABASE_NAME }}
      MONTH_DATABASE_NAME: ${{ vars.MONTH_DATABASE_NAME }}
      DAY_DATABASE_NAME: ${{ vars.DAY_DATABASE_NAME }}
      REF: ${{ github.ref }}
      REPOSITORY: ${{ github.repository }}
      YEAR: ${{ vars.YEAR || '2024' }}
      ENABLE_HEATMAP: ${{ vars.ENABLE_HEATMAP || 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # æ˜ç¡®å®‰è£… github-heatmap
          pip install github-heatmap
      
      - name: Verify Installation
        run: |
          echo "ğŸ” éªŒè¯å®‰è£…..."
          echo "Python åŒ…åˆ—è¡¨:"
          pip list | grep -i heatmap || echo "æ²¡æœ‰æ‰¾åˆ° heatmap ç›¸å…³åŒ…"
          
          echo "å°è¯•å¯¼å…¥æ¨¡å—:"
          python -c "import github_heatmap; print('âœ… github_heatmap æ¨¡å—å¯ä»¥å¯¼å…¥')" || echo "âŒ æ— æ³•å¯¼å…¥ github_heatmap æ¨¡å—"
          
          echo "æ£€æŸ¥æ¨¡å—ç‰ˆæœ¬:"
          python -c "import github_heatmap; print(f'ç‰ˆæœ¬: {github_heatmap.__version__}')" 2>/dev/null || echo "æ— æ³•è·å–ç‰ˆæœ¬"
      
      # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
      - name: Make scripts executable
        run: |
          chmod +x scripts/*.py || echo "æ²¡æœ‰æ‰¾åˆ° scripts ç›®å½•"
      
      # éªŒè¯å¾®ä¿¡è¯»ä¹¦ Cookie
      - name: Validate Weread Cookie
        id: validate_cookie
        run: |
          if [ -f "scripts/validate_cookie.py" ]; then
            python scripts/validate_cookie.py
          else
            echo "âš ï¸ validate_cookie.py ä¸å­˜åœ¨ï¼Œè·³è¿‡éªŒè¯"
          fi
      
      # è·å–å¾®ä¿¡è¯»ä¹¦ç”¨æˆ· ID
      - name: Get Weread User ID
        id: get_user_id
        run: |
          if [ -f "scripts/get_user_id.py" ]; then
            USER_ID=$(python scripts/get_user_id.py)
            echo "USER_ID=$USER_ID" >> $GITHUB_ENV
            echo "user_id=$USER_ID" >> $GITHUB_OUTPUT
            echo "è·å–åˆ°çš„ç”¨æˆ·ID: $USER_ID"
          else
            echo "âŒ get_user_id.py ä¸å­˜åœ¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨æ–¹æ³•ï¼šä»ç¯å¢ƒå˜é‡è·å–
            if [ -n "${{ secrets.NAME }}" ]; then
              echo "USER_ID=${{ secrets.NAME }}" >> $GITHUB_ENV
              echo "ä½¿ç”¨ secrets.NAME: ${{ secrets.NAME }}"
            else
              echo "USER_ID=" >> $GITHUB_ENV
              echo "âš ï¸ æ— æ³•è·å–ç”¨æˆ·ID"
            fi
          fi
      
      # ç”Ÿæˆçƒ­åŠ›å›¾ - ä½¿ç”¨ Python æ¨¡å—æ–¹å¼
      - name: Generate Heatmap
        if: env.ENABLE_HEATMAP == 'true' && env.USER_ID != ''
        run: |
          echo "ğŸ¨ ç”Ÿæˆå¾®ä¿¡è¯»ä¹¦çƒ­åŠ›å›¾..."
          echo "ç”¨æˆ·ID: $USER_ID"
          echo "å¹´ä»½: $YEAR"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p ./OUT_FOLDER
          
          # ä½¿ç”¨ Python æ¨¡å—æ–¹å¼è¿è¡Œï¼ˆè¿™æ˜¯æœ€å¯é çš„æ–¹æ³•ï¼‰
          python -m github_heatmap weread \
            --year $YEAR \
            --me "$USER_ID" \
            --without-type-name \
            --background-color=${{ vars.background_color || '#FFFFFF' }} \
            --track-color=${{ vars.track_color || '#ACE7AE' }} \
            --special-color1=${{ vars.special_color || '#69C16E' }} \
            --special-color2=${{ vars.special_color2 || '#549F57' }} \
            --dom-color=${{ vars.dom_color || '#EBEDF0' }} \
            --text-color=${{ vars.text_color || '#000000' }}
          
          # æ£€æŸ¥è¾“å‡º
          echo "ğŸ“ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶:"
          ls -la ./OUT_FOLDER/ 2>/dev/null || echo "OUT_FOLDER ç›®å½•ä¸å­˜åœ¨"
          
          if [ -f "./OUT_FOLDER/weread.svg" ]; then
            echo "âœ… çƒ­åŠ›å›¾ç”ŸæˆæˆåŠŸ: ./OUT_FOLDER/weread.svg"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < ./OUT_FOLDER/weread.svg) å­—èŠ‚"
          else
            echo "âŒ çƒ­åŠ›å›¾ç”Ÿæˆå¤±è´¥"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–è¾“å‡ºä½ç½®:"
            find . -name "*.svg" -type f 2>/dev/null | head -10 || echo "æ²¡æœ‰æ‰¾åˆ° SVG æ–‡ä»¶"
          fi
      
      # å¤„ç†çƒ­åŠ›å›¾æ–‡ä»¶
      - name: Process Heatmap File
        if: env.ENABLE_HEATMAP == 'true' && env.USER_ID != ''
        run: |
          if [ -f "./OUT_FOLDER/weread.svg" ]; then
            RANDOM_FILENAME=$(uuidgen).svg
            mv ./OUT_FOLDER/weread.svg ./OUT_FOLDER/$RANDOM_FILENAME
            echo "âœ… é‡å‘½åçƒ­åŠ›å›¾æ–‡ä»¶ä¸º: $RANDOM_FILENAME"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° weread.svg æ–‡ä»¶ï¼Œè·³è¿‡é‡å‘½å"
          fi
      
      # ä¸»è¦çš„åŒæ­¥ä»»åŠ¡
      - name: weread book sync
        run: |
          echo "å¼€å§‹ä¹¦ç±åŒæ­¥..."
          book || echo "ä¹¦ç±åŒæ­¥å®Œæˆ"
      
      - name: weread sync
        run: |
          echo "å¼€å§‹ç¬”è®°åŒæ­¥..."
          weread || echo "ç¬”è®°åŒæ­¥å®Œæˆ"
